<table id="transaction-table">
    <thead>
        <tr>
            <th>Date & Time</th>
            <th>Category</th>
            <th>Subcategory</th>
            <th>Amount</th>
        </tr>
    </thead>
    <tbody>
    </tbody>
</table>
<!-- Pagination Container -->
<div id="pagination-container" class="pagination" style="display: none;"></div>
<script>
let currentPage = 1;
let totalPages = 1;
let transactions = [];

async function fetchApiData(page = 1) {
    const jsonDataElement = document.getElementById('jsonData');
    const tableBody = document.querySelector('#transaction-table tbody');
    const paginationContainer = document.getElementById('pagination-container');
    
    if (jsonDataElement) {
        jsonDataElement.textContent = 'Loading...';
    }
    
    if (tableBody) {
        tableBody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
    }
    
    try {
        const response = await fetch(`/api/transactions?page=${page}`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        
        // Store the fetched data
        transactions = data.transactions || [];
        totalPages = data.num_pages || 1;
        
        // Display JSON data if element exists
        if (jsonDataElement) {
            jsonDataElement.textContent = JSON.stringify(data, null, 2);
        }
        
        // Populate the table
        if (tableBody) {
            populateTable(transactions);
        }
        
        // Update pagination controls
        updatePagination(page);
        
        currentPage = page;
    } catch (error) {
        if (jsonDataElement) {
            jsonDataElement.textContent = `Error: ${error.message}`;
        }
        if (tableBody) {
            tableBody.innerHTML = `<tr><td colspan="4">Error: ${error.message}</td></tr>`;
        }
    }
}

function populateTable(transactions) {
    const tableBody = document.querySelector('#transaction-table tbody');
    
    if (!tableBody) return;
    
    // Clear existing rows
    tableBody.innerHTML = '';
    
    if (transactions.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4">No transactions found</td></tr>';
        return;
    }
    
    // Add each transaction as a row
    transactions.forEach(transaction => {
        const row = document.createElement('tr');
        
        // Format the datetime for display
        const dateTime = new Date(transaction.datetime);
        const formattedDateTime = dateTime.toLocaleString();
        
        row.innerHTML = `
            <td>${formattedDateTime}</td>
            <td>${transaction.category}</td>
            <td>${transaction.subcategory}</td>
            <td>${transaction.amount}</td>
        `;
        
        tableBody.appendChild(row);
    });
}

function updatePagination(currentPage) {
    const paginationContainer = document.getElementById('pagination-container');
    
    if (!paginationContainer) return;
    
    // Clear existing pagination
    paginationContainer.innerHTML = '';
    
    // Show pagination if there's more than 1 page
    if (totalPages > 1) {
        paginationContainer.style.display = 'block';
        
        // Add Previous buttons
        if (currentPage > 1) {
            const firstButton = document.createElement('button');
            firstButton.className = 'pagination-btn';
            firstButton.textContent = '« First';
            firstButton.addEventListener('click', () => fetchApiData(1));
            paginationContainer.appendChild(firstButton);
            
            const prevButton = document.createElement('button');
            prevButton.className = 'pagination-btn';
            prevButton.textContent = 'Previous';
            prevButton.addEventListener('click', () => fetchApiData(currentPage - 1));
            paginationContainer.appendChild(prevButton);
        }
        
        // Add page numbers
        for (let i = 1; i <= totalPages; i++) {
            if (i === currentPage) {
                const currentButton = document.createElement('button');
                currentButton.className = 'pagination-btn current';
                currentButton.textContent = i;
                currentButton.disabled = true;
                paginationContainer.appendChild(currentButton);
            } else if (i > currentPage - 3 && i < currentPage + 3) {
                const pageButton = document.createElement('button');
                pageButton.className = 'pagination-btn';
                pageButton.textContent = i;
                pageButton.addEventListener('click', () => fetchApiData(i));
                paginationContainer.appendChild(pageButton);
            }
        }
        
        // Add Next buttons
        if (currentPage < totalPages) {
            const nextButton = document.createElement('button');
            nextButton.className = 'pagination-btn';
            nextButton.textContent = 'Next';
            nextButton.addEventListener('click', () => fetchApiData(currentPage + 1));
            paginationContainer.appendChild(nextButton);
            
            const lastButton = document.createElement('button');
            lastButton.className = 'pagination-btn';
            lastButton.textContent = 'Last »';
            lastButton.addEventListener('click', () => fetchApiData(totalPages));
            paginationContainer.appendChild(lastButton);
        }
    } else {
        paginationContainer.style.display = 'none';
    }
}
function showPage(page) {
    const startIndex = (page - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageTransactions = allTransactions.slice(startIndex, endIndex);
    
    populateTable(pageTransactions);
    updatePagination(page);
}

// Load initial data on page load
document.addEventListener('DOMContentLoaded', () => {
    fetchApiData(1);
});
</script>
