<div>
    <h2>Category Summary</h2>
    <div id="category-summary"></div>
</div>
<script>
    // Wait for DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        const updateBtn = document.getElementById('updateBtn');
        const categorySummary = document.getElementById('category-summary');
        
        updateBtn.addEventListener('click', function() {
            fetch('/api/category-summary/')
                .then(response => {
                    if (!response.ok) {
                        console.log(response);
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    updateCategorySummary(data);
                })
                .catch(error => {
                    categorySummary.innerHTML = '<p>Error loading data: ' + error.message + '</p>';
                });
        });

        function updateCategorySummary(data) {
            let html = '';
            
            // Loop through categories
            for (const [category, subcategories] of Object.entries(data.categories)) {
                html += `<h3>${category}</h3>`;
                html += '<ul>';
                
                // Loop through subcategories
                for (const [subcategory, value] of Object.entries(subcategories)) {
                    html += `<li>${subcategory}: ${value}</li>`;
                }
                
                html += '</ul>';
            }
            
            // Add grand total
            html += `<h3>Grand Total: ${data.grand_total}</h3>`;
            
            categorySummary.innerHTML = html;
        }
    });
</script>
<button id="updateBtn" class="update-button">Update Summary</button>
<button id="export-excel-btn" class="btn btn-primary">Export to Excel</button>
<div id="export-progress" style="display: none;">
    <p>Generating Excel file... Please wait.</p>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const exportBtn = document.getElementById('export-excel-btn');
    const progressDiv = document.getElementById('export-progress');
    
    exportBtn.addEventListener('click', async function() {
        try {
            // Show progress indicator
            progressDiv.style.display = 'block';
            exportBtn.disabled = true;
            exportBtn.textContent = 'Generating...';
            
            // Make POST request
            const response = await fetch('/api/excel-export/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                },
            });
            
            if (response.ok) {
                // Get the blob from response
                const blob = await response.blob();
                
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'data_export.xlsx';
                document.body.appendChild(a);
                a.click();
                
                // Cleanup
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } else {
                throw new Error('Export failed');
            }
        } catch (error) {
            console.error('Export error:', error);
            alert('Error exporting data. Please try again.');
        } finally {
            // Hide progress indicator
            progressDiv.style.display = 'none';
            exportBtn.disabled = false;
            exportBtn.textContent = 'Export to Excel';
        }
    });
    
    // Function to get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
<button id="compileBtn">Download PDF</button>
<!-- Import the Typst compiler -->
<script type="module">
import myriaddreamintypstTsWebCompiler from 'https://cdn.jsdelivr.net/npm/@myriaddreamin/typst-ts-web-compiler@0.7.0-rc2/+esm'

// Make it available globally
let typstCompiler = myriaddreamintypstTsWebCompiler;

document.getElementById('compileBtn').addEventListener('click', async function() {
    const button = this;
    const originalText = button.textContent;
    
    try {
        button.textContent = 'Loading...';
        button.disabled = true;
        
        // 1. Fetch the JSON data
        const response = await fetch('/api/typst-json');
        const data = await response.json();
        
        // 2. Format data for Typst
        // Convert from {category: {subcategory: value}} to [[category, [[subcategory, value]]]]
        const typstData = [];
        for (const [category, subcategories] of Object.entries(data)) {
            const subcatArray = [];
            for (const [subcat, value] of Object.entries(subcategories)) {
                subcatArray.push([subcat, value]);
            }
            typstData.push([category, subcatArray]);
        }
        
        // 3. Prepare the Typst content
        const typstContent = `#let subtitle(b) = [
          #for i in b [
            == #i.at(0)
            #for j in i.at(1) [
              *#j.at(0)*... #j.at(1) \\
            ]
          ]
        ]

        #subtitle((${JSON.stringify(typstData)}))`;
        
        // 4. Initialize and compile using the correct API
        const compiler = await typstCompiler();
        
        // Compile the document
        const result = await compiler.compile({
            entryPoint: 'main.typ',
            // Use Artifact as output format for PDF
            outputFormat: 'pdf',
            // Pass the source content
            mainContent: typstContent
        });
        
        if (!result.success) {
            throw new Error(`Compilation failed: ${result.logs?.join('\n')}`);
        }
        
        // 5. Download - result might be ArrayBuffer or Uint8Array
        let pdfBytes;
        if (result.output instanceof ArrayBuffer) {
            pdfBytes = result.output;
        } else if (result.output instanceof Uint8Array) {
            pdfBytes = result.output.buffer;
        } else if (result.output?.buffer instanceof ArrayBuffer) {
            pdfBytes = result.output.buffer;
        } else {
            throw new Error('Unexpected output format');
        }
        
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'document.pdf';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        button.textContent = originalText;
        button.disabled = false;
        
    } catch (error) {
        console.error('Error:', error);
        button.textContent = 'Error - Try Again';
        button.disabled = false;
        setTimeout(() => {
            button.textContent = originalText;
        }, 2000);
    }
});
</script>
