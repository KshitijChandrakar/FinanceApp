<div style="">
    <!-- Main area on the left -->
    <form id="transactionForm">
        {% csrf_token %}
        <div>
            <label for="category">Category:</label>
            <select id="category" name="category" required>
                <option value="">Select a category</option>
            </select>
        </div>
        <div>
            <label for="subcategory">Subcategory:</label>
            <select id="subcategory" name="subcategory" required disabled>
                <option value="">Select a category first</option>
            </select>
        </div>
        <div>
            <label for="amount">Amount:</label>
            <input type="number"
                   id="amount"
                   name="amount"
                   step="0.01"
                   min="0.01"
                   class="amount-input"
                   required>
        </div>
        <button type="submit" class="update-button">Submit</button>
    </form>
    <div id="message"></div>
    <script>
            document.addEventListener('DOMContentLoaded', function() {
            const categorySelect = document.getElementById('category');
            const subcategorySelect = document.getElementById('subcategory');
            const amountInput = document.getElementById('amount');
            const form = document.getElementById('transactionForm');
            const messageDiv = document.getElementById('message');
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            let categoriesData = {};
            
            // Fetch categories from API
            fetch('/api/category')
                .then(response => response.json())
                .then(data => {
                    categoriesData = data;
                    
                    // Populate category dropdown
                    Object.keys(data).forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        categorySelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading categories:', error);
                    messageDiv.textContent = 'Failed to load categories';
                    messageDiv.style.color = 'red';
                });
            
            // Handle category change to populate subcategories
            categorySelect.addEventListener('change', function() {
                const selectedCategory = this.value;
                subcategorySelect.innerHTML = '<option value="">Select a subcategory</option>';
                subcategorySelect.disabled = !selectedCategory;
                
                if (selectedCategory && categoriesData[selectedCategory]) {
                    categoriesData[selectedCategory].forEach(subcategory => {
                        const option = document.createElement('option');
                        option.value = subcategory;
                        option.textContent = subcategory;
                        subcategorySelect.appendChild(option);
                    });
                }
            });
            
            // Validate amount input
            amountInput.addEventListener('input', function() {
                const value = parseFloat(this.value);
                if (value <= 0) {
                    this.setCustomValidity('Amount must be positive');
                } else {
                    this.setCustomValidity('');
                }
            });
            
            // Handle form submission
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Validate amount
                const amountValue = parseFloat(amountInput.value);
                if (!amountValue || amountValue <= 0) {
                    messageDiv.textContent = 'Please enter a valid positive amount';
                    messageDiv.style.color = 'red';
                    return;
                }
                
                // Validate category and subcategory
                const category = categorySelect.value;
                const subcategory = subcategorySelect.value;
                
                if (!category || !categoriesData[category]) {
                    messageDiv.textContent = 'Please select a valid category';
                    messageDiv.style.color = 'red';
                    return;
                }
                
                if (!subcategory || !categoriesData[category].includes(subcategory)) {
                    messageDiv.textContent = 'Please select a valid subcategory';
                    messageDiv.style.color = 'red';
                    return;
                }
                
                // Prepare JSON data
                const transactionData = {
                    category: category,
                    subcategory: subcategory,
                    amount: amountValue
                };
                
                // Submit to API
                fetch('/api/transaction-add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(transactionData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    messageDiv.textContent = 'Transaction added successfully!';
                    messageDiv.style.color = 'green';
                    form.reset();
                    subcategorySelect.disabled = true;
                })
                .catch(error => {
                    console.error('Error:', error);
                    messageDiv.textContent = 'Failed to add transaction';
                    messageDiv.style.color = 'red';
                });
            });
        });
    </script>
</div>
