<button id="compileBtn">Download PDF</button>
<!-- Import the Typst compiler -->
<script type="module">
import myriaddreamintypstTsWebCompiler from 'https://cdn.jsdelivr.net/npm/@myriaddreamin/typst-ts-web-compiler@0.7.0-rc2/+esm'

// Make it available globally
let typstCompiler = myriaddreamintypstTsWebCompiler;

document.getElementById('compileBtn').addEventListener('click', async function() {
    const button = this;
    const originalText = button.textContent;
    
    try {
        button.textContent = 'Loading...';
        button.disabled = true;
        
        // 1. Fetch the JSON data
        const response = await fetch('/api/typst-json');
        const data = await response.json();
        
        // 2. Format data for Typst
        // Convert from {category: {subcategory: value}} to [[category, [[subcategory, value]]]]
        const typstData = [];
        for (const [category, subcategories] of Object.entries(data)) {
            const subcatArray = [];
            for (const [subcat, value] of Object.entries(subcategories)) {
                subcatArray.push([subcat, value]);
            }
            typstData.push([category, subcatArray]);
        }
        
        // 3. Prepare the Typst content
        const typstContent = `#let subtitle(b) = [
          #for i in b [
            == #i.at(0)
            #for j in i.at(1) [
              *#j.at(0)*... #j.at(1) \\
            ]
          ]
        ]

        #subtitle((${JSON.stringify(typstData)}))`;
        
        // 4. Initialize and compile using the correct API
        const compiler = await typstCompiler();
        
        // Compile the document
        const result = await compiler.compile({
            entryPoint: 'main.typ',
            // Use Artifact as output format for PDF
            outputFormat: 'pdf',
            // Pass the source content
            mainContent: typstContent
        });
        
        if (!result.success) {
            throw new Error(`Compilation failed: ${result.logs?.join('\n')}`);
        }
        
        // 5. Download - result might be ArrayBuffer or Uint8Array
        let pdfBytes;
        if (result.output instanceof ArrayBuffer) {
            pdfBytes = result.output;
        } else if (result.output instanceof Uint8Array) {
            pdfBytes = result.output.buffer;
        } else if (result.output?.buffer instanceof ArrayBuffer) {
            pdfBytes = result.output.buffer;
        } else {
            throw new Error('Unexpected output format');
        }
        
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'document.pdf';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        button.textContent = originalText;
        button.disabled = false;
        
    } catch (error) {
        console.error('Error:', error);
        button.textContent = 'Error - Try Again';
        button.disabled = false;
        setTimeout(() => {
            button.textContent = originalText;
        }, 2000);
    }
});
</script>
